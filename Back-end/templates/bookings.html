<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Appointment</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex justify-center items-center p-4">

  <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg p-6">

        <h2 class="text-2xl font-semibold mb-4 text-center">Select a Service</h2>
        
        <div id="servicesContainer" class="flex justify-center gap-3 mb-6 flex-wrap"></div>

        <!-- Service Image Display -->
        <div id="serviceImageContainer" class="flex justify-center mb-6 hidden">
          <img id="serviceImage" src="" alt="Service Image" class="max-w-xs rounded-lg shadow-md">
        </div>

        <h2 id="monthTitle" class="text-2xl font-semibold mb-4 text-center"></h2>

        <div id="daysContainer" class="flex justify-center gap-2 mb-6 flex-wrap"></div>

        <div id="timesContainer" class="flex justify-center gap-2 mb-6 flex-wrap"></div>

        <div id="summary" class="border rounded-lg p-4 mb-4 hidden">
      <div class="flex justify-between items-center mb-2">
        <h3 id="serviceName" class="font-medium">Women's French Braid (Adriana)</h3>
        <span id="servicePrice" class="font-semibold text-gray-800">$240.00</span>
      </div>
      <p id="timeSummary" class="text-sm text-gray-500"></p>
    </div>

        <div id="totalSection" class="flex justify-between text-gray-700 text-lg font-medium mb-6 hidden">
      <span>Total:</span>
      <span id="totalPrice">$240.00 (2 hours)</span>
    </div>

        <form id="bookingForm" method="POST" action="/api/bookings" class="flex flex-col gap-4">
      <input type="hidden" id="bookingType" name="booking_type" value="Women's French Braid (Adriana)" />
      <input type="hidden" id="appointmentDatetime" name="appointment_datetime" value="" />

      <button type="submit" id="continueBtn" disabled
        class="w-full py-3 bg-cyan-600 text-white rounded-lg font-medium hover:bg-cyan-700 transition">
        Continue
      </button>
    </form>

  </div>

  <script>
    // Services will be loaded from API
    let services = {};
    let availableTimes = {};

    const servicesContainer = document.getElementById('servicesContainer');
    const serviceImageContainer = document.getElementById('serviceImageContainer');
    const serviceImage = document.getElementById('serviceImage');
    const monthTitle = document.getElementById('monthTitle');
    const daysContainer = document.getElementById('daysContainer');
    const timesContainer = document.getElementById('timesContainer');
    const timeSummary = document.getElementById('timeSummary');
    const summary = document.getElementById('summary');
    const totalSection = document.getElementById('totalSection');
    const totalPrice = document.getElementById('totalPrice');
    const continueBtn = document.getElementById('continueBtn');
    const bookingForm = document.getElementById('bookingForm');
    const serviceName = document.getElementById('serviceName');
    const servicePrice = document.getElementById('servicePrice');

    const appointmentInput = document.getElementById('appointmentDatetime');
    const bookingTypeInput = document.getElementById('bookingType');

    let selectedService = null;
    let selectedDate = null;
    let selectedTime = null;

    // Render service selection buttons
    function renderServices() {
      servicesContainer.innerHTML = '';
      Object.values(services).forEach(service => {
        const btn = document.createElement('button');
        btn.textContent = service.name;
        btn.className = "px-4 py-2 rounded-lg bg-gray-100 hover:bg-cyan-100 transition";
        btn.onclick = () => selectService(service, btn);
        servicesContainer.appendChild(btn);
      });
    }

    // Select service
    function selectService(service, button) {
      selectedService = service;
      selectedDate = null;
      selectedTime = null;

      // Reset service button styles
      [...servicesContainer.children].forEach(b => {
        b.classList.remove('bg-cyan-600', 'text-white');
        b.classList.add('bg-gray-100');
      });
      button.classList.add('bg-cyan-600', 'text-white');

      // Show service image
      if (service.image) {
        serviceImage.src = service.image;
        serviceImageContainer.classList.remove('hidden');
      } else {
        serviceImageContainer.classList.add('hidden');
      }

      // Clear calendar and times
      daysContainer.innerHTML = '';
      timesContainer.innerHTML = '';
      summary.classList.add('hidden');
      totalSection.classList.add('hidden');
      continueBtn.disabled = true;

      // Show calendar (will use availableTimes loaded from API)
      if (Object.keys(availableTimes).length > 0) {
        renderCalendar();
      } else {
        monthTitle.textContent = "No available dates";
        daysContainer.innerHTML = '<p class="text-gray-500">No availability scheduled. Please check back later.</p>';
      }
    }

    function renderCalendar() {
      if (Object.keys(availableTimes).length === 0) {
        monthTitle.textContent = "No available dates";
        daysContainer.innerHTML = '<p class="text-gray-500">No availability scheduled. Please check back later.</p>';
        return;
      }

      // Get all unique dates and sort them
      const dates = Object.keys(availableTimes).sort();
      if (dates.length === 0) {
        monthTitle.textContent = "No available dates";
        daysContainer.innerHTML = '<p class="text-gray-500">No availability scheduled.</p>';
        return;
      }

      // Show month/year from first date
      const firstDate = new Date(dates[0]);
      monthTitle.textContent = firstDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      daysContainer.innerHTML = '';

      dates.forEach(date => {
        const d = new Date(date);
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const dayNum = d.getDate();
        const month = d.toLocaleDateString('en-US', { month: 'short' });

        const btn = document.createElement('button');
        btn.textContent = `${dayName} ${month} ${dayNum}`;
        btn.className = "px-3 py-2 rounded-lg bg-gray-100 hover:bg-cyan-100 transition";
        btn.onclick = () => selectDay(date, btn);

        daysContainer.appendChild(btn);
      });
    }

    function selectDay(date, button) {
      if (!selectedService) return;
      
      selectedDate = date;
      selectedTime = null;
      summary.classList.add('hidden');
      totalSection.classList.add('hidden');
      continueBtn.disabled = true;

      [...daysContainer.children].forEach(b => {
        b.classList.remove('bg-cyan-600', 'text-white');
        b.classList.add('bg-gray-100');
      });
      button.classList.add('bg-cyan-600', 'text-white');

      renderTimes(date);
    }

    function renderTimes(date) {
      timesContainer.innerHTML = '';
      if (!availableTimes[date] || availableTimes[date].length === 0) {
        timesContainer.innerHTML = '<p class="text-gray-500">No times available for this date.</p>';
        return;
      }
      availableTimes[date].forEach(time => {
        const btn = document.createElement('button');
        btn.textContent = time;
        btn.className = "px-4 py-2 rounded-lg bg-gray-100 hover:bg-cyan-100 transition";
        btn.onclick = () => selectTime(time, btn);
        timesContainer.appendChild(btn);
      });
    }

    function selectTime(time, button) {
      if (!selectedService) return;
      
      selectedTime = time;

      [...timesContainer.children].forEach(b => {
        b.classList.remove('bg-cyan-600', 'text-white');
        b.classList.add('bg-gray-100');
      });
      button.classList.add('bg-cyan-600', 'text-white');

      summary.classList.remove('hidden');
      totalSection.classList.remove('hidden');

      continueBtn.disabled = false;

      appointmentInput.value = `${selectedDate} ${selectedTime}`;
      bookingTypeInput.value = selectedService.name;

      // Update service display
      serviceName.textContent = selectedService.name;
      servicePrice.textContent = `$${selectedService.price.toFixed(2)}`;
      
      const endTime = calculateEndTime(time, selectedService.duration);
      timeSummary.textContent = `${time} – ${endTime}`;
      
      // Update total
      totalPrice.textContent = `$${selectedService.price.toFixed(2)} (${selectedService.duration} hours)`;
    }

    function calculateEndTime(start, hours) {
      const [t, modifier] = start.split(' ');
      let [h, m] = t.split(':').map(Number);
      if (modifier === 'PM' && h !== 12) h += 12;
      if (modifier === 'AM' && h === 12) h = 0;

      const date = new Date();
      date.setHours(h + hours, m);
      return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    }

    // --- Form Submission Handler ---
    bookingForm.addEventListener('submit', function (e) {
        e.preventDefault();
        
        if (!selectedService || !selectedDate || !selectedTime) {
            alert('Please select a service, date, and time');
            return;
        }

        // Submit to backend API
        const formData = new FormData();
        formData.append('booking_type', bookingTypeInput.value);
        formData.append('appointment_datetime', appointmentInput.value);

        fetch('/api/bookings', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response;
            }
            throw new Error('Booking failed');
        })
        .then(() => {
            alert(`Booking confirmed for ${selectedService.name} on ${selectedDate} at ${selectedTime}`);
            // Redirect to login page after booking
            window.location.href = '/login';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create booking. Please try again.');
        });
    });
    // -------------------------------

    // Load services from API
    async function loadServices() {
      try {
        const response = await fetch('/api/services');
        if (!response.ok) {
          console.error('Failed to load services');
          return;
        }
        const data = await response.json();
        
        // Convert API response to the format expected by the rest of the code
        const servicesMap = {};
        
        data.services.forEach(service => {
          servicesMap[service.name] = {
            name: service.name,
            price: service.price || 0,
            duration: Math.round(service.duration_minutes / 60 * 10) / 10, // Convert minutes to hours
            image: service.image_path || '/static/about/image 1.jpg'
          };
        });
        
        services = servicesMap;
        availableTimes = data.available_times || {};
        
        // Re-render services
        renderServices();
        
        // If a service was already selected, re-render calendar with new data
        if (selectedService) {
          renderCalendar();
        }
      } catch (error) {
        console.error('Error loading services:', error);
      }
    }

    // Initialize
    loadServices();
  </script>
</body>
</html>
