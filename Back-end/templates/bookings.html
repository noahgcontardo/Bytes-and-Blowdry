<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Appointment</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex justify-center items-center p-4">

  <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg p-6">

        <h2 class="text-2xl font-semibold mb-4 text-center">Select a Service</h2>
        
        <div id="servicesContainer" class="flex justify-center gap-3 mb-6 flex-wrap"></div>

        <h2 id="monthTitle" class="text-2xl font-semibold mb-4 text-center"></h2>

        <div id="daysContainer" class="flex justify-center gap-2 mb-6 flex-wrap"></div>

        <div id="timesContainer" class="flex justify-center gap-2 mb-6 flex-wrap"></div>

        <div id="summary" class="border rounded-lg p-4 mb-4 hidden">
      <div class="flex justify-between items-center mb-2">
        <h3 id="serviceName" class="font-medium">Women's French Braid (Adriana)</h3>
        <span id="servicePrice" class="font-semibold text-gray-800">$240.00</span>
      </div>
      <p id="timeSummary" class="text-sm text-gray-500"></p>
    </div>

        <div id="totalSection" class="flex justify-between text-gray-700 text-lg font-medium mb-6 hidden">
      <span>Total:</span>
      <span id="totalPrice">$240.00 (2 hours)</span>
    </div>

        <form id="bookingForm" method="POST" action="/api/bookings" class="flex flex-col gap-4">
      <input type="hidden" id="bookingType" name="booking_type" value="Women's French Braid (Adriana)" />
      <input type="hidden" id="appointmentDatetime" name="appointment_datetime" value="" />

      <button type="submit" id="continueBtn" disabled
        class="w-full py-3 bg-cyan-600 text-white rounded-lg font-medium hover:bg-cyan-700 transition">
        Continue
      </button>
    </form>

  </div>

  <script>
    // Available services
    const services = {
      "Women's French Braid (Adriana)": {
        name: "Women's French Braid (Adriana)",
        price: 240,
        duration: 2
      },
      "Coloring": {
        name: "Coloring",
        price: 240,
        duration: 2
      },
      "Straightening": {
        name: "Straightening",
        price: 240,
        duration: 2
      }
    };

    const availableTimes = {
      '2025-12-04': ['9:00 AM', '11:15 AM', '1:15 PM'],
      '2025-12-05': ['10:00 AM', '12:30 PM'],
      '2025-12-06': ['9:00 AM', '11:15 AM', '1:15 PM'],
      '2025-12-07': ['8:30 AM', '2:00 PM']
    };

    const servicesContainer = document.getElementById('servicesContainer');
    const monthTitle = document.getElementById('monthTitle');
    const daysContainer = document.getElementById('daysContainer');
    const timesContainer = document.getElementById('timesContainer');
    const timeSummary = document.getElementById('timeSummary');
    const summary = document.getElementById('summary');
    const totalSection = document.getElementById('totalSection');
    const totalPrice = document.getElementById('totalPrice');
    const continueBtn = document.getElementById('continueBtn');
    const bookingForm = document.getElementById('bookingForm');
    const serviceName = document.getElementById('serviceName');
    const servicePrice = document.getElementById('servicePrice');

    const appointmentInput = document.getElementById('appointmentDatetime');
    const bookingTypeInput = document.getElementById('bookingType');

    let selectedService = null;
    let selectedDate = null;
    let selectedTime = null;

    // Render service selection buttons
    function renderServices() {
      servicesContainer.innerHTML = '';
      Object.values(services).forEach(service => {
        const btn = document.createElement('button');
        btn.textContent = service.name;
        btn.className = "px-4 py-2 rounded-lg bg-gray-100 hover:bg-cyan-100 transition";
        btn.onclick = () => selectService(service, btn);
        servicesContainer.appendChild(btn);
      });
    }

    // Select service
    function selectService(service, button) {
      selectedService = service;
      selectedDate = null;
      selectedTime = null;

      // Reset service button styles
      [...servicesContainer.children].forEach(b => {
        b.classList.remove('bg-cyan-600', 'text-white');
        b.classList.add('bg-gray-100');
      });
      button.classList.add('bg-cyan-600', 'text-white');

      // Clear calendar and times
      daysContainer.innerHTML = '';
      timesContainer.innerHTML = '';
      summary.classList.add('hidden');
      totalSection.classList.add('hidden');
      continueBtn.disabled = true;

      // Show calendar
      renderCalendar();
    }

    function renderCalendar() {
      monthTitle.textContent = "December 2025";
      daysContainer.innerHTML = '';

      Object.keys(availableTimes).forEach(date => {
        const d = new Date(date);
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const dayNum = d.getDate();

        const btn = document.createElement('button');
        btn.textContent = `${dayName} ${dayNum}`;
        btn.className = "px-3 py-2 rounded-lg bg-gray-100 hover:bg-cyan-100 transition";
        btn.onclick = () => selectDay(date, btn);

        daysContainer.appendChild(btn);
      });
    }

    function selectDay(date, button) {
      if (!selectedService) return;
      
      selectedDate = date;
      selectedTime = null;
      summary.classList.add('hidden');
      totalSection.classList.add('hidden');
      continueBtn.disabled = true;

      [...daysContainer.children].forEach(b => {
        b.classList.remove('bg-cyan-600', 'text-white');
        b.classList.add('bg-gray-100');
      });
      button.classList.add('bg-cyan-600', 'text-white');

      renderTimes(date);
    }

    function renderTimes(date) {
      timesContainer.innerHTML = '';
      availableTimes[date].forEach(time => {
        const btn = document.createElement('button');
        btn.textContent = time;
        btn.className = "px-4 py-2 rounded-lg bg-gray-100 hover:bg-cyan-100 transition";
        btn.onclick = () => selectTime(time, btn);
        timesContainer.appendChild(btn);
      });
    }

    function selectTime(time, button) {
      if (!selectedService) return;
      
      selectedTime = time;

      [...timesContainer.children].forEach(b => {
        b.classList.remove('bg-cyan-600', 'text-white');
        b.classList.add('bg-gray-100');
      });
      button.classList.add('bg-cyan-600', 'text-white');

      summary.classList.remove('hidden');
      totalSection.classList.remove('hidden');

      continueBtn.disabled = false;

      appointmentInput.value = `${selectedDate} ${selectedTime}`;
      bookingTypeInput.value = selectedService.name;

      // Update service display
      serviceName.textContent = selectedService.name;
      servicePrice.textContent = `$${selectedService.price.toFixed(2)}`;
      
      const endTime = calculateEndTime(time, selectedService.duration);
      timeSummary.textContent = `${time} – ${endTime}`;
      
      // Update total
      totalPrice.textContent = `$${selectedService.price.toFixed(2)} (${selectedService.duration} hours)`;
    }

    function calculateEndTime(start, hours) {
      const [t, modifier] = start.split(' ');
      let [h, m] = t.split(':').map(Number);
      if (modifier === 'PM' && h !== 12) h += 12;
      if (modifier === 'AM' && h === 12) h = 0;

      const date = new Date();
      date.setHours(h + hours, m);
      return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    }

    // --- Form Submission Handler ---
    bookingForm.addEventListener('submit', function (e) {
        e.preventDefault();
        
        if (!selectedService || !selectedDate || !selectedTime) {
            alert('Please select a service, date, and time');
            return;
        }

        // Submit to backend API
        const formData = new FormData();
        formData.append('booking_type', bookingTypeInput.value);
        formData.append('appointment_datetime', appointmentInput.value);

        fetch('/api/bookings', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response;
            }
            throw new Error('Booking failed');
        })
        .then(() => {
            alert(`Booking confirmed for ${selectedService.name} on ${selectedDate} at ${selectedTime}`);
            // Redirect to login page after booking
            window.location.href = '/login';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create booking. Please try again.');
        });
    });
    // -------------------------------

    // Initialize
    renderServices();
  </script>
</body>
</html>
